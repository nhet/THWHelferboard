
<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>THEOrganigramm</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
 
</head>
<body hx-boost="true">
  <main>
  {% block content %}
    <header class="site-header">
      <h1>Helferboard - Admin</h1>
      <nav>
        <a href="/">Öffentlich</a>
        <a href="/admin">Admin</a>
        <a href="/admin/functions">Funktionen</a>
        <a href="/admin/helpers">Helfer</a>
        <a href="/admin/groups">Gruppen</a>
        <a href="/admin/settings">Einstellungen</a>
      </nav>
    </header>
    {% block admin_content %}{% endblock %}
  {% endblock %}
  </main>
  <script>
    document.addEventListener('paste', function (e) {
      const files = e.clipboardData.files;
      if (files.length > 0) {
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput) {
          fileInput.files = files;
          const label = fileInput.closest('label');
          if(label) {
            let hint = label.querySelector('.paste-hint');
            if(!hint) {
              hint = document.createElement('span');
              hint.className = 'paste-hint';
              hint.textContent = ' (Bild aus Zwischenablage eingefügt)';
              label.appendChild(hint);
            }
          }
        }
      }
    });

    (function() {
      function initClickableRows() {
        document.querySelectorAll('.list-table tbody tr').forEach(function(tr) {
          var href = tr.getAttribute('data-href');
          if(!href) return;
          tr.style.cursor = 'pointer';
          tr.tabIndex = 0;
          tr.addEventListener('click', function(e) {
            if (e.target.closest('a, button, form, input')) return;
            window.location = href;
          });
          tr.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
              if (e.target.closest('a, button, form, input')) return;
              e.preventDefault();
              window.location = href;
            }
          });
        });
      }

      function makeHeadersSortable(table) {
        var thead = table.querySelector('thead');
        if(!thead) return;
        thead.querySelectorAll('th').forEach(function(th, idx) {
          if(th.classList.contains('no-sort')) return;
          if(th.querySelector('.sort-indicator')) return; // already initialized
          th.classList.add('sortable');
          var span = document.createElement('span');
          span.className = 'sort-indicator';
          th.appendChild(span);
          th.tabIndex = 0;
          th.addEventListener('click', function() { sortByColumn(table, idx); });
          th.addEventListener('keydown', function(e) { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); sortByColumn(table, idx); } });
        });
      }

      function sortByColumn(table, colIndex) {
        var currentCol = table.dataset.sortCol ? parseInt(table.dataset.sortCol) : null;
        var currentDir = table.dataset.sortDir || 'asc';
        var newDir = (currentCol === colIndex && currentDir === 'asc') ? 'desc' : 'asc';
        var tbody = table.querySelector('tbody');
        var rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort(function(a,b) {
          var aText = (a.children[colIndex] && a.children[colIndex].textContent || '').trim();
          var bText = (b.children[colIndex] && b.children[colIndex].textContent || '').trim();
          var aNum = parseFloat(aText.replace(/[^0-9,.-]/g, '').replace(',','.'));
          var bNum = parseFloat(bText.replace(/[^0-9,.-]/g, '').replace(',','.'));
          if(!isNaN(aNum) && !isNaN(bNum)) {
            return (aNum - bNum) * (newDir === 'asc' ? 1 : -1);
          }
          return (aText.localeCompare(bText, 'de', {numeric:true}) * (newDir === 'asc' ? 1 : -1));
        });
        // Re-attach rows
        rows.forEach(function(r){ tbody.appendChild(r); });
        // Update state and header classes
        table.dataset.sortCol = colIndex;
        table.dataset.sortDir = newDir;
        table.querySelectorAll('th').forEach(function(th, idx){
          th.classList.remove('sort-asc','sort-desc');
          if(idx === colIndex) th.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc');
        });
      }

      function initFilter(table) {
        var toolbar = table.previousElementSibling;
        if(!toolbar || !toolbar.classList.contains('table-toolbar')) return;
        var input = toolbar.querySelector('.table-filter');
        if(!input) return;
        var reset = toolbar.querySelector('.table-filter-reset');
        function updateResetVisibility() {
          if(!reset) return;
          if((input.value || '').trim()) reset.classList.remove('hidden'); else reset.classList.add('hidden');
        }
        // debounce
        var timeout;
        input.addEventListener('input', function() {
          clearTimeout(timeout);
          timeout = setTimeout(function(){ applyFilter(table, input.value); }, 150);
          updateResetVisibility();
        });
        input.addEventListener('keydown', function(e) {
          if(e.key === 'Escape') {
            if(reset) reset.click();
          }
        });
        if(reset) {
          reset.addEventListener('click', function() {
            input.value = '';
            applyFilter(table, '');
            updateResetVisibility();
            try { input.focus(); } catch(e) {}
          });
        }
        // set initial state
        updateResetVisibility();
      }

      function applyFilter(table, query) {
        query = (query || '').trim().toLowerCase();
        var rows = table.querySelectorAll('tbody tr');
        rows.forEach(function(r){
          var text = Array.from(r.children).map(function(c){ return c.textContent.trim().toLowerCase(); }).join(' ');
          var match = !query || text.indexOf(query) !== -1;
          r.style.display = match ? '' : 'none';
        });
      }

      function initTableTools() {
        document.querySelectorAll('.list-table').forEach(function(table) {
          makeHeadersSortable(table);
          initFilter(table);
        });
        // Focus the first table filter input on initial load so typing can start immediately
        if(!document.activeElement || document.activeElement === document.body) {
          var firstFilter = document.querySelector('.table-filter');
          if(firstFilter) {
            try { firstFilter.focus({preventScroll:true}); } catch(e) { firstFilter.focus(); }
            if(firstFilter.select) try { firstFilter.select(); } catch(e) {}
          }
        }
      }

      document.addEventListener('DOMContentLoaded', function() { initClickableRows(); initTableTools(); });
      // Re-init if DOM changes (HTMX or dynamic inserts)
      var observer = new MutationObserver(function() { initClickableRows(); initTableTools(); });
      observer.observe(document.body, {childList:true, subtree:true});
    })();
  </script>
  </body>
</html>