
{% extends 'admin/base.html' %}
{% block admin_content %}
<h2>{% if helper %}Helfer bearbeiten{% else %}Neuer Helfer{% endif %}</h2>
<form method="post" action="/admin/helpers/save" enctype="multipart/form-data">
  {% if helper %}
    <input type="hidden" name="id" value="{{ helper.id }}" />
  {% endif %}
  <label>Vorname<br>
    <input name="first_name" required value="{{ helper.first_name if helper else '' }}" />
  </label>
  <label>Nachname<br>
    <input name="last_name" required value="{{ helper.last_name if helper else '' }}" />
  </label>

    <label>Gruppe<br>
      <select id="group-select" name="group_id" required placeholder="Bitte wählen...">
        <option value=""></option>
        {% for g in groups %}
          <option value="{{g.id}}" {% if helper and helper.group_id == g.id %}selected{% endif %}>{{ g.name }}</option>
        {% endfor %}
      </select>
      <div class="error-message">Bitte wählen Sie eine Gruppe aus</div>
    </label>


  <label>Hauptfunktion<br>
    <select id="main-function-select" name="main_function_id" required placeholder="Bitte wählen...">
      <option value=""></option>
      {% for f in functions %}
        <option value="{{f.id}}" {% if helper and helper.main_function_id == f.id %}selected{% endif %}>{{ f.name }}</option>
      {% endfor %}
    </select>
    <div class="error-message">Bitte wählen Sie eine Hauptfunktion aus</div>
  </label>
  <label>Nebenfunktionen<br>
    <select id="secondary-select" multiple>
      {% for f in functions %}
        <option value="{{f.id}}" {% if helper and f in helper.secondary_functions %}selected{% endif %}>{{ f.name }}</option>
      {% endfor %}
    </select>
  </label>
    <label>Foto<br>
    <input type="file" name="photo" accept="image/*" />
  </label>
  <input type="hidden" name="secondary_function_ids" id="secondary_function_ids" value="{{ sec_ids if sec_ids else '' }}" />
  <link href="{{ url_for('static', path='tom-select.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', path='tom-select.complete.min.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() 
    {
      
      const secondary_functionsTS = new TomSelect("#secondary-select",
      {
          plugins: ['remove_button'],
          create: false,
          render: {
              no_results: function(data, escape) 
              {
                  return '<div class="no-results">Keine Ergebnisse für "' + escape(data.input) + '" gefunden</div>';
              },
              option_create: function(data, escape) 
              {
                  return '<div class="create">Hinzufügen <strong>' + escape(data.input) + '</strong>&hellip;</div>';
              },
          },
      });
      secondary_functionsTS.on('change', (value) => {
        document.getElementById('secondary_function_ids').value = value.join(',');
      });

      const mainFunc = new TomSelect("#main-function-select",{
        create: false,
        allowEmptyOption: false,
        sortField: {
          field: "text",
          direction: "asc"
        },
        render: {
              no_results: function(data, escape) 
              {
                  return '<div class="no-results">Keine Ergebnisse für "' + escape(data.input) + '" gefunden</div>';
              },
              option_create: function(data, escape) 
              {
                  return '<div class="create">Hinzufügen <strong>' + escape(data.input) + '</strong>&hellip;</div>';
              },
          },
      });

      const group = new TomSelect("#group-select",{
        create: false,
        allowEmptyOption: false,
        sortField: {
          field: "text",
          direction: "asc"
        },
        render: {
              no_results: function(data, escape) 
              {
                  return '<div class="no-results">Keine Ergebnisse für "' + escape(data.input) + '" gefunden</div>';
              },
              option_create: function(data, escape) 
              {
                  return '<div class="create">Hinzufügen <strong>' + escape(data.input) + '</strong>&hellip;</div>';
              },
          },
      });

      const form = document.querySelector('form');
      form.addEventListener('submit', function(e) {
        let isValid = true;
        if (!group.getValue()) {
          group.wrapper.classList.add('is-invalid');
          isValid = false;
        }
        if (!mainFunc.getValue()) {
            mainFunc.wrapper.classList.add('is-invalid');
            isValid = false;
        }
        if (!isValid) {
            e.preventDefault();
        }
      });
      
      group.on('change', () => {
       if (group.getValue()) 
       {
          group.wrapper.classList.remove('is-invalid');
       }
      });

      mainFunc.on('change', () => {
        if (mainFunc.getValue()) {
            mainFunc.wrapper.classList.remove('is-invalid');
        }
      });
    });
  </script>
    <div class="form-actions">
    <button class="btn" type="submit">Speichern</button>
    <a class="btn" href="/admin/helpers">Abbrechen</a>
  </div>
</form>

  {% if helper and helper.photo_path %}
    <p>Aktuelles Foto:<br>
      <img src="{{ url_for('static', path=helper.photo_path) }}" style="height:120px;border-radius:8px"/>
      <form method="post" action="/admin/helpers/{{ helper.id }}/delete_photo" style="display:inline" onsubmit="return confirm('Bild wirklich löschen?')">
        <button class="btn danger" type="submit">Löschen</button>
      </form>
    </p>
  {% endif %}

{% endblock %}
