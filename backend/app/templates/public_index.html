
{% extends 'base.html' %}
{% block content %}
{% if incognito_level >= 2 %}
  {% if carousel_title %}
  <h1 class="carousel-title">{{ carousel_title }}</h1>
  {% endif %}

  {% if carousel_images %}
      <div class="carousel-container-large">
        <div class="carousel-large {% if carousel_images|length == 1 %}single-image{% endif %}">
          {% set total = carousel_images|length %}
          {% for img in carousel_images %}
            <div class="carousel-item-large"
              {% if total > 1 %}
                style="--total-slides: {{ total }}; --animation-delay: {{ loop.index0 }};"
              {% endif %}>
              <!-- Low-res background for very fast load -->
              <img class="bg" src="{{ url_for('static', path=img.path.replace('.jpg', '-thumb-sm.webp').replace('.jpeg', '-thumb-sm.webp').replace('.png', '-thumb-sm.webp')) }}" alt="">
              <!-- Optimized carousel image (max 1000px) -->
              <picture class="fg">
                <source srcset="{{ url_for('static', path=img.path.replace('.jpg', '-carousel.webp').replace('.jpeg', '-carousel.webp').replace('.png', '-carousel.webp')) }}" type="image/webp">
                <source srcset="{{ url_for('static', path=img.path.replace('.jpg', '-carousel.avif').replace('.jpeg', '-carousel.avif').replace('.png', '-carousel.avif')) }}" type="image/avif">
                <img src="{{ url_for('static', path=img.path) }}" alt="">
              </picture>
            </div>
          {% endfor %}
        </div>
      </div>
 {% endif %}


{% endif %}
{% if incognito_level < 2 %}
<div class="public-page">
  <div class="legende">
  <span class="legend-title">Legende:</span>
  {% for func in allFunctionsInUse %}
    {% if func.emblem_svg_path %}
      <div class="legend-item">
        <img height="25px"
             src="{{ url_for('static', path=func.emblem_svg_path) }}"
             alt="Dienststellungskennzeichen-{{ func.short_name }}">
        <span class="legend-text">{{ func.legend_name }}</span>
      </div>
    {% endif %}
  {% endfor %}
</div>

  {% for node in tree %}
    <div class="group-section" style="--indent: 0px">
      <h2 class="group-title">{{ node.group.name }} ({{node.helpers|length}})</h2>
      <div class="helper-grid">
        <div class="helper-track">
        {% for h in node.helpers %}
          <div class="helper-card">
            <div class="helper-photo">
              {% if h.photo_path %}
                <picture>
                  <source srcset="{{ url_for('static', path=h.photo_path.replace('.jpg', '-thumb-sm.webp').replace('.jpeg', '-thumb-sm.webp').replace('.png', '-thumb-sm.webp')) }} 1x, {{ url_for('static', path=h.photo_path.replace('.jpg', '-thumb-md.webp').replace('.jpeg', '-thumb-md.webp').replace('.png', '-thumb-md.webp')) }} 2x" type="image/webp">
                  <source srcset="{{ url_for('static', path=h.photo_path.replace('.jpg', '-thumb-sm.avif').replace('.jpeg', '-thumb-sm.avif').replace('.png', '-thumb-sm.avif')) }} 1x, {{ url_for('static', path=h.photo_path.replace('.jpg', '-thumb-md.avif').replace('.jpeg', '-thumb-md.avif').replace('.png', '-thumb-md.avif')) }} 2x" type="image/avif">
                  <img src="{{ url_for('static', path=h.photo_path.replace('.jpg', '-thumb-sm.jpg').replace('.jpeg', '-thumb-sm.jpg').replace('.png', '-thumb-sm.jpg')) }}"
                       srcset="{{ url_for('static', path=h.photo_path.replace('.jpg', '-thumb-sm.jpg').replace('.jpeg', '-thumb-sm.jpg').replace('.png', '-thumb-sm.jpg')) }} 1x, {{ url_for('static', path=h.photo_path.replace('.jpg', '-thumb-md.jpg').replace('.jpeg', '-thumb-md.jpg').replace('.png', '-thumb-md.jpg')) }} 2x"
                       sizes="110px"
                       width="110" height="110"
                       loading="lazy" decoding="async"
                       alt="{{h.first_name}} {{h.last_name}}" />
                </picture>
              {% else %}
                <img src="{{ url_for('static', path='placeholder-photo.svg') }}"
                     width="110" height="110" loading="lazy" decoding="async"
                     alt="Platzhalter" />
              {% endif %}
            </div>
            <div class="helper-name fn">
              {% if incognito_level >= 1 %}
                {{ h.first_name[0] }}.
              {% else %}
                {{ h.first_name }}
              {% endif %}
            </div>
            <div class="helper-name ln">
              {% if incognito_level >= 1 %}
                {{ h.last_name[0] }}.
              {% else %}
                {{ h.last_name }}
              {% endif %}
            </div>
            <div class="helper-emblem">
              {% if h.main_function and h.main_function.emblem_svg_path %}
                <img src="{{ url_for('static', path=h.main_function.emblem_svg_path) }}" height="28" loading="lazy" decoding="async" alt="Dienststellungskennzeichen-{{ h.main_function.name }}" />
              {% else %}
                <span class="no-emblem">â€“</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% endif %}
{% if incognito_level < 2 %}
<script>
  // Synchronized horizontal group sliders
  document.addEventListener('DOMContentLoaded', () => {
    const grids = Array.from(document.querySelectorAll('.helper-grid')).filter(g => g.querySelectorAll('.helper-card').length > 9);

    if (grids.length === 0) {
      setTimeout(switchPage, 30000);
      return;
    }

    // Collect all tracks and their max offsets
    const sliders = grids.map(grid => {
      const track = grid.querySelector('.helper-track');
      if (!track) return null;
      
      const maxOffset = Math.max(0, track.scrollWidth - grid.clientWidth);
      if (maxOffset <= 1) return null;
      
      return { grid, track, maxOffset };
    }).filter(s => s !== null);

    if (sliders.length === 0) {
      setTimeout(switchPage, 30000);
      return;
    }

    // Global state for all sliders
    const state = {
      pos: 0,
      direction: 1, // 1 forward, -1 backward
      pxPerMs: 0.03,
      paused: false,
      lastTime: performance.now(),
      lastUpdate: 0,
      rafId: null,
      reachedEndCount: 0, // Track how many sliders reached their max
      maxOffsetsReached: new Set() // Track which sliders have reached their end
    };

    function step(now) {
      if (state.paused) return;

      // Throttle to ~30fps to reduce CPU usage on Raspberry Pi
      if (now - state.lastUpdate < 33) {
        state.rafId = requestAnimationFrame(step);
        return;
      }
      state.lastUpdate = now;

      const dt = now - state.lastTime;
      state.lastTime = now;
      state.pos += state.direction * state.pxPerMs * dt;

      // Check if any slider reached its max offset
      state.reachedEndCount = 0;
      sliders.forEach(slider => {
        const canMove = state.pos <= slider.maxOffset;
        if (!canMove) {
          state.maxOffsetsReached.add(slider.track);
          state.reachedEndCount++;
        }
      });

      // If moving forward and all sliders reached their max, pause at end
      if (state.direction === 1 && state.reachedEndCount === sliders.length) {
        state.pos = Math.max(...sliders.map(s => s.maxOffset));
        sliders.forEach(slider => {
          slider.track.style.transform = `translate3d(${-Math.min(state.pos, slider.maxOffset)}px,0,0)`;
        });
        // Pause and reverse
        state.paused = true;
        setTimeout(() => {
          state.paused = false;
          state.direction = -1;
          state.lastTime = performance.now();
          state.maxOffsetsReached.clear();
          state.rafId = requestAnimationFrame(step);
        }, 5000);
        return;
      }

      // If moving backward and reached start, pause and go forward again
      if (state.direction === -1 && state.pos <= 0) {
        state.pos = 0;
        sliders.forEach(slider => {
          slider.track.style.transform = `translate3d(0,0,0)`;
        });
        state.paused = true;
        /*setTimeout(() => {
          state.paused = false;
          state.direction = 1;
          state.lastTime = performance.now();
          state.rafId = requestAnimationFrame(step);
        }, 5000);*/
        setTimeout(switchPage, 5000);
        return;
      }

      // Update all sliders with current position (clamped to their individual max)
      sliders.forEach(slider => {
        const clampedPos = Math.min(state.pos, slider.maxOffset);
        slider.track.style.transform = `translate3d(${-clampedPos}px,0,0)`;
      });

      state.rafId = requestAnimationFrame(step);
    }

    // Start after a short delay
    setTimeout(() => {
      state.lastTime = performance.now();
      state.rafId = requestAnimationFrame(step);
    }, 1000);
  });
</script>
{% endif %}
{% if detail_groups %}
{% set pages_list = ["/"] %}
{% for g in detail_groups %}
{% do pages_list.append("/group/" + g.id|string) %}
{% endfor %}
<script>
  const pages = {{ pages_list | tojson | safe }};
  let currentIndex = 0;

  function switchPage() {
    if (window.serverReachable && pages.length > 1){
      currentIndex = (currentIndex + 1) % pages.length;
      window.location.href = pages[currentIndex];
    }
  }

  window.addEventListener('sliderCycleComplete', () => {
    setTimeout(switchPage, 5000);
  });
  window.addEventListener('noSliders', () => {
    setTimeout(switchPage, 5000);
  });
</script>
{% endif %}
{% endblock %}
